<!DOCTYPE html><head><title>Viktor Břenek</title><meta content="text/html;charset=utf-8" http-equiv="Content-Type"><meta content="utf-8" http-equiv="encoding"><meta name="author" content="Petr Břenek"><meta name="description" content="Osobní blog a portfolio"><meta property="og:image" content="http://viktorbrenek.github.io/assets/images/modely.png"><meta name="viewport" content="width=device-width,initial-scale=1.0"><link rel="stylesheet" href="../styles.css"><meta charset="utf-8"><title>Blog</title></head><body><ul class="links" id="links"> <li><a class="who" href="https://discord.com/invite/2Uj6N5N" target="_blank">Discord</a></li><li><a class="blog" href="https://www.youtube.com/c/ViktorBřenekYT" target="_blank">Youtube</a></li><li><a class="source" href="https://github.com/viktorbrenek" target="_blank">Github</a></li></ul><menu><a class="name" href="#">Viktor Břenek</a><a class="name" href="../blog.html">Blog</a><a class="name" href="../index.html">Portfolio</a></menu><main class="gridblog"><h1 class="atitle">Using Vue-CLI to serve an Express app</h1><div><span><ul class="task__tags"><li class="task__tag task__tag--copyright">Vue.js</li><li class="task__tag task__tag--copyright">Vue</li><li class="task__tag task__tag--copyright">vue-cli</li><li class="task__tag task__tag--copyright">vue-cli-service</li><li class="task__tag task__tag--copyright">Express</li><li class="task__tag task__tag--copyright">API</li></ul></span></div><p>The Vue-CLI is great, but one thing I struggled with and found no resources on:
How to serve an Express app alongside the UI without using another process?
Accomplishing this is actually pretty easy and I hope to provide some guidance with this article.</p>
<h2>Starting point</h2>
<p>In my case the Express serves the API for the Vue UI.
This case is also described in the Vue CLI docs:
Just use the <a href="https://cli.vuejs.org/config/#devserver-proxy"><code>devServer.proxy</code></a> config for that and you are done.
But not so fast …</p>
<p>Using the proxy setup you have to start separate servers for the UI and API.
Depending on your case this might make sense, but for me both are intertwined and having one server makes things way easier:
<mark>In dev mode we can use the existing Webpack Dev Server, which is based on Express;
running the E2E tests you will likely need the Express server running as well.</mark></p>
<p>Here is how to set this up so that running <code>vue-cli-service serve</code> spins up one Express for the API and UI.</p>
<h2>Configuration</h2>
<p>Let’s start with the <code>vue.config.js</code> file, which looks like this:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> configureAPI = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./src/server/configure'</span>)

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">before</span>: configureAPI
  }
}
</code></pre>
<p>Wow, that is as short as the proxy config, but what does it do?
It leverages the <a href="https://webpack.js.org/configuration/dev-server/#devserverbefore">Webpack Dev Server <code>before</code> callback</a>, which does the heavy lifting.</p>
<p>I keep my server stuff in <code>src/server</code>, which contains the following <code>configure.js</code> that is imported above:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)
<span class="hljs-keyword">const</span> api = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./api'</span>)

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {
  app.use(bodyParser.json())
  app.use(<span class="hljs-string">'/api'</span>, api)
}
</code></pre>
<p>The <code>api.js</code> file contains the <a href="https://expressjs.com/en/guide/routing.html#express-router">Express Router</a> definitions for the API routes, but that is up to you.
<mark>The important part is that the <code>configure</code> module exports a function, which adds the API config to the Webpack Dev Server:</mark>
The <code>before</code> callback invokes this function with the Express <code>app</code> instance as the first argument;
the second argument is the Webpack Dev Server instance, which we can safely ignore here.</p>
<p>That is all you actually need for the development and testing environment, freaking simple!</p>
<h3>Optional: Server restart on change</h3>
<p>To reload the dev server whenever the Express/API code changes you can use <a href="https://github.com/remy/nodemon#running-non-node-scripts">nodemon</a>.
The <code>npm start</code> script looks like this:</p>
<pre><code class="language-bash">nodemon --<span class="hljs-built_in">exec</span> <span class="hljs-string">'vue-cli-service serve'</span>
</code></pre>
<p>The accompanying <code>nodemon.json</code> configures the watch directory:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"watch"</span>: [
    <span class="hljs-string">"src/server"</span>
  ]
}
</code></pre>
<h2>In production</h2>
<p>For completeness sake, here is also what I am doing in production:
The <code>src/server</code> directory contains an <code>index.js</code> file like the following:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> { resolve } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">const</span> history = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-history-api-fallback'</span>)
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> configureAPI = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./configure'</span>)
<span class="hljs-keyword">const</span> app = express()

<span class="hljs-keyword">const</span> { PORT = <span class="hljs-number">3000</span> } = process.env

<span class="hljs-comment">// API</span>
configureAPI(app)

<span class="hljs-comment">// UI</span>
<span class="hljs-keyword">const</span> publicPath = resolve(__dirname, <span class="hljs-string">'../../dist'</span>)
<span class="hljs-keyword">const</span> staticConf = { <span class="hljs-attr">maxAge</span>: <span class="hljs-string">'1y'</span>, <span class="hljs-attr">etag</span>: <span class="hljs-literal">false</span> }

app.use(express.static(publicPath, staticConf))
app.use(<span class="hljs-string">'/'</span>, history())

<span class="hljs-comment">// Go</span>
app.listen(PORT, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`App running on port <span class="hljs-subst">${PORT}</span>!`</span>))
</code></pre>
<p>This file contains all the config and logic to bring up the Express server in production;
it is run using <code>NODE_ENV=production node src/server</code>.</p>
<p>The shared <code>configureAPI</code> is passed the <code>app</code> instance that we create ourselves in this scenario.
Besides that it also leverages Expess’ static file serving to serve the UI.
Here we also enable the <a href="https://router.vuejs.org/guide/essentials/history-mode.html">Vue Router history push state navigation</a> as well. You can find more guidance on <a href="https://cli.vuejs.org/guide/deployment.html">how to deploy a Vue CLI app</a> in the official docs.</p>
</main><footer></footer></body>